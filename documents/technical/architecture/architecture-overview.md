# HugMeDo システムアーキテクチャ概要

**文書番号**: ARCH-001  
**作成日**: 2025-03-21  
**最終更新日**: 2025-03-22  
**バージョン**: 1.0.1  
**ステータス**: 確定  
**関連文書**: 
- ARCH-002 (コンテナ化モジュラーモノリス)
- DEC-001 (ディレクトリ構造設計)
- GUIDE-002 (開発環境セットアップ)

## 1. アーキテクチャの選択

本プロジェクトでは、コンテナ化モジュラーモノリスアーキテクチャを採用しました。このアーキテクチャは、モノリスの単純さとマイクロサービスの柔軟性を組み合わせたアプローチです。

### 1.1 アーキテクチャの特徴

- **モジュラー構造**: 機能ごとに明確に分離されたモジュール
- **コンテナ化**: Docker/Docker Composeによる環境の一貫性確保
- **単一デプロイメント**: 全体を単一のユニットとしてデプロイ
- **明確な境界**: モジュール間のインターフェースを明示的に定義
- **共有カーネル**: 共通機能を提供するコアライブラリ

### 1.2 選択理由

- 開発チームの規模に適合
- 迅速な開発と展開が可能
- 運用の複雑さを最小限に抑制
- 将来的なマイクロサービスへの移行パスを確保
- 医療情報システムとしての堅牢性確保

## 2. システム構成

### 2.1 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                      HugMeDo Application                     │
│                                                             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │   Web   │  │  Mobile │  │  Admin  │  │   API   │        │
│  │   App   │  │   App   │  │ Console │  │ Gateway │        │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘        │
│       │            │            │            │             │
│       └────────────┴────────────┴────────────┘             │
│                           │                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   Shared Kernel                     │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌────────┐  │   │
│  │  │   Auth  │  │  Common │  │  Utils  │  │ Config │  │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                     Modules                         │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌────────┐  │   │
│  │  │   OHR   │  │  HALCA  │  │  Chat   │  │ Others │  │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                             │
                      ┌──────┴──────┐
                      │  Database   │
                      └─────────────┘
```

### 2.2 主要コンポーネント

#### 2.2.1 アプリケーション層

- **Web App**: Svelteベースのウェブアプリケーション
- **Mobile App**: Svelteベースのモバイル対応アプリケーション
- **Admin Console**: 管理者向けインターフェース

#### 2.2.2 共有カーネル（packages/core）

- **Auth**: 認証・認可機能のインターフェースと型定義
- **API**: API関連のユーティリティと共通インターフェース
- **Types**: 共通型定義
- **Utils**: 汎用ユーティリティ関数

#### 2.2.3 機能モジュール

- **API Gateway**: 外部APIとの連携インターフェース、認証実装を含む
- **OHR**: オンライン診療モジュール（Amazon Chime SDK使用）
- **HALCA**: メンタルヘルスチェックモジュール（PHQ-9ベース）
- **Chat**: チャットコミュニケーションモジュール
- **Others**: その他の機能モジュール

#### 2.2.4 データ層

- **PostgreSQL**: 主要データベース
- **Redis**: キャッシュとセッション管理（オプション）

## 3. 開発環境

### 3.1 ローカル開発環境

- **Docker Compose**: 全サービスのローカル実行
- **pnpm**: パッケージ管理
- **TypeScript**: 型安全な開発環境

### 3.2 開発環境構成

```yaml
# docker-compose.yml (概要)
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgres://postgres:postgres@db:5432/hugmedo
    volumes:
      - .:/app
    depends_on:
      - db
      - ohr
      - halca
      - chat

  ohr:
    build: ./modules/ohr
    ports:
      - "40100:40100"
    environment:
      - NODE_ENV=development

  halca:
    build: ./modules/halca
    ports:
      - "40120:40120"
    environment:
      - NODE_ENV=development

  chat:
    build: ./modules/chat
    ports:
      - "40110:40110"
    environment:
      - NODE_ENV=development

  db:
    image: postgres:14
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=hugmedo
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

## 4. 本番環境（AWS）

### 4.1 AWS構成図

```
                                 ┌───────────────┐
                                 │  Route 53     │
                                 └───────┬───────┘
                                         │
                                 ┌───────▼───────┐
                                 │ CloudFront    │◄────┐
                                 └───────┬───────┘     │
                                         │             │
                                 ┌───────▼───────┐     │
┌───────────────┐               │ Application    │     │
│   Cognito     │◄──────────────► Load Balancer  │     │
└───────────────┘               └───────┬───────┘     │
                                        │              │
                                ┌───────▼───────┐      │
                                │   ECS Cluster  │      │
                                │ ┌───────────┐ │      │
                                │ │HugMeDo App │ │      │
                                │ │(Container) │ │      │
                                │ └───────────┘ │      │
                                └───────┬───────┘      │
                                        │              │
                        ┌───────────────┼──────────────┘
                        │               │
                ┌───────▼───────┐ ┌─────▼───────┐
                │  RDS Postgres │ │ S3 Bucket   │
                └───────────────┘ └─────────────┘
```

### 4.2 AWS主要サービス

- **Amazon ECS**: アプリケーションコンテナの実行環境
- **Amazon RDS**: PostgreSQLデータベース
- **Amazon Cognito**: ユーザー認証（推奨オプション）
- **Amazon Route 53**: DNSサービス
- **Amazon CloudFront**: CDNサービス
- **Application Load Balancer**: 負荷分散
- **Amazon S3**: 静的ファイル保存
- **Amazon CloudWatch**: 監視とログ管理

## 5. セキュリティ設計

### 5.1 認証システム

Amazon Cognitoを採用し、以下の機能を実装：

- JWTベースの認証
- 多要素認証（MFA）
- ソーシャルIDプロバイダー連携
- セッション管理

### 5.2 データ保護

- 転送中の暗号化（TLS 1.3）
- 保存データの暗号化（RDS暗号化）
- センシティブデータの分離
- バックアップと復元手順

### 5.3 アクセス制御

- 最小権限の原則に基づくIAMポリシー
- セキュリティグループによるネットワーク分離
- VPC内のプライベートサブネット配置

## 6. スケーラビリティ計画

### 6.1 短期的スケーリング

- ECSサービスの自動スケーリング
- RDSのリードレプリカ（必要に応じて）
- CloudFrontによるキャッシュ最適化

### 6.2 長期的スケーリング

- マイクロサービスへの段階的移行
- データベースのシャーディング
- グローバル展開のためのマルチリージョン構成

## 7. 監視と運用

### 7.1 監視システム

- CloudWatchダッシュボード
- アラート設定
- ログ集約
- パフォーマンスメトリクス

### 7.2 CI/CD

- GitHub Actionsによる自動デプロイ
- テスト自動化
- ブルー/グリーンデプロイメント

## 8. コンプライアンス

医療情報システムとして以下の基準に準拠：

- 個人情報保護法
- 医療情報システムのセキュリティガイドライン
- HIPAA（将来の国際展開に備えて）

## 9. 今後の展望

- 機械学習モジュールの統合
- リアルタイム分析機能

---

*このドキュメントは、HugMeDoプロジェクトのアーキテクチャ概要を示すものであり、詳細な実装は各モジュールのドキュメントを参照してください。*

最終更新: 2025-03-21
