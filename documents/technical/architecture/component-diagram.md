# HugMeDo コンポーネント図と関連性

## 文書情報

| 項目 | 内容 |
|------|------|
| 文書番号 | ARCH-003 |
| 作成日 | 2025-03-21 |
| 作成者 | HugMeDoチーム |
| ステータス | ドラフト |
| 関連文書 | ARCH-001（アーキテクチャ概要）, ARCH-002（データベース設計） |

## 1. 概要

本文書は、HugMeDoプラットフォームの主要コンポーネントとそれらの関連性を図示し、説明します。コンテナ化モジュラーモノリスアーキテクチャに基づき、各モジュールの責任範囲と相互作用を明確にします。

## 2. システムコンポーネント図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             クライアント層                                    │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │     Web UI      │  │    Mobile UI    │  │    Admin UI     │             │
│  │   (SvelteKit)   │  │  (SvelteKit PWA)│  │   (SvelteKit)   │             │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘             │
│           │                    │                    │                       │
└───────────┼────────────────────┼────────────────────┼───────────────────────┘
            │                    │                    │
            │                    │                    │
┌───────────┼────────────────────┼────────────────────┼───────────────────────┐
│           │                    │                    │                       │
│           ▼                    ▼                    ▼                       │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │                         API Gateway                             │        │
│  │                         (Express.js)                            │        │
│  └────────────────────────────────┬────────────────────────────────┘        │
│                                   │                                         │
│                                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │                       認証・認可レイヤー                          │        │
│  │                    (Amazon Cognito / JWT)                       │        │
│  └────────────────────────────────┬────────────────────────────────┘        │
│                                   │                                         │
│                                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │                         共有カーネル                             │        │
│  │                                                                 │        │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │        │
│  │  │ ユーザー管理 │  │  通知管理   │  │ 設定管理    │  │ ログ管理 │ │        │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │        │
│  └────────────────────────────────┬────────────────────────────────┘        │
│                                   │                                         │
│                                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │                       機能モジュール                             │        │
│  │                                                                 │        │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │        │
│  │  │ OHRモジュール │  │HALCAモジュール│  │ チャットモジュール│  │ その他  │ │        │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────┬────┘ │        │
│  └─────────┼───────────────┼───────────────┼───────────────┼─────────        │
│            │               │               │               │                │
│            ▼               ▼               ▼               ▼                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ Amazon Chime │  │   AI/ML API  │  │  WebSocket   │  │  外部サービス │     │
│  │     SDK      │  │              │  │   サーバー    │  │   連携API    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             データ層                                        │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │  PostgreSQL DB  │  │    Redis Cache  │  │   S3 Storage    │             │
│  │ (ユーザー/モジュール) │  │ (セッション/キャッシュ)│  │  (ファイル/メディア) │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3. コンポーネント詳細

### 3.1 クライアント層

#### Web UI (SvelteKit)
- **責任**: ブラウザベースのユーザーインターフェース提供
- **主要技術**: SvelteKit, TypeScript, TailwindCSS
- **特徴**: レスポンシブデザイン、PWA対応、アクセシビリティ対応

#### Mobile UI (SvelteKit PWA)
- **責任**: モバイルデバイス向けインターフェース提供
- **主要技術**: SvelteKit, PWA, Capacitor (オプション)
- **特徴**: オフライン対応、プッシュ通知、ネイティブ機能アクセス

#### Admin UI (SvelteKit)
- **責任**: 管理者向けダッシュボードとコントロールパネル
- **主要技術**: SvelteKit, TypeScript, データ可視化ライブラリ
- **特徴**: 高度な分析機能、バッチ処理、システム設定管理

### 3.2 サーバー層

#### API Gateway (Express.js)
- **責任**: クライアントリクエストのルーティングと前処理
- **主要技術**: Express.js, TypeScript
- **特徴**: リクエスト検証、レート制限、ログ記録、エラーハンドリング

#### 認証・認可レイヤー (Amazon Cognito / JWT)
- **責任**: ユーザー認証と権限管理
- **主要技術**: Amazon Cognito, JWT, RBAC
- **特徴**: セキュアなトークン管理、多要素認証、ソーシャルログイン

### 3.3 共有カーネル

#### ユーザー管理
- **責任**: ユーザープロファイル、設定、権限の管理
- **主要機能**: ユーザー登録、プロファイル更新、権限割り当て

#### 通知管理
- **責任**: システム通知とアラートの処理
- **主要機能**: 通知生成、配信、既読管理

#### 設定管理
- **責任**: システム設定と環境変数の管理
- **主要機能**: 設定読み込み、検証、更新

#### ログ管理
- **責任**: システムログとアクティビティ記録
- **主要機能**: ログ記録、クエリ、アーカイブ

### 3.4 機能モジュール

#### OHRモジュール
- **責任**: オンラインビデオ通話と遠隔診療機能
- **主要技術**: Amazon Chime SDK, WebRTC
- **主要機能**: 
  - 会議作成と管理
  - 参加者管理
  - 画面共有
  - チャット機能
  - 録画機能（オプション）

#### HALCAモジュール
- **責任**: メンタルヘルスチェックと評価
- **主要技術**: AI/ML API, 自然言語処理
- **主要機能**:
  - PHQ-9ベースの評価
  - 方言対応（伊勢方言等）
  - 結果分析と推奨
  - 履歴追跡

#### チャットモジュール
- **責任**: リアルタイムおよび非同期メッセージング
- **主要技術**: WebSocket, Socket.io
- **主要機能**:
  - 1対1チャット
  - グループチャット
  - メディア共有
  - 既読確認

#### その他モジュール
- **責任**: 追加機能の提供（予約管理、レポート等）
- **主要技術**: モジュールに依存
- **主要機能**: 拡張機能

### 3.5 外部サービス連携

#### Amazon Chime SDK
- **責任**: ビデオ会議機能の提供
- **連携方法**: AWS SDK経由
- **データフロー**: OHRモジュール ⟷ Amazon Chime SDK

#### AI/ML API
- **責任**: 自然言語処理と分析機能
- **連携方法**: REST API
- **データフロー**: HALCAモジュール ⟷ AI/ML API

#### WebSocketサーバー
- **責任**: リアルタイム通信の処理
- **連携方法**: WebSocket接続
- **データフロー**: チャットモジュール ⟷ WebSocketサーバー

#### 外部サービス連携API
- **責任**: サードパーティサービスとの連携
- **連携方法**: REST API, GraphQL
- **データフロー**: 各モジュール ⟷ 外部サービス

### 3.6 データ層

#### PostgreSQL DB
- **責任**: 永続的データの保存
- **主要データ**: ユーザー情報、モジュールデータ、システム設定
- **特徴**: トランザクション保証、リレーショナルデータモデル

#### Redis Cache
- **責任**: 一時データとセッション管理
- **主要データ**: セッション情報、キャッシュデータ、一時状態
- **特徴**: 高速アクセス、有効期限設定、パブリッシュ/サブスクライブ

#### S3 Storage
- **責任**: ファイルとメディアの保存
- **主要データ**: 画像、動画、文書、バックアップ
- **特徴**: 高耐久性、スケーラブル、アクセス制御

## 4. コンポーネント間の相互作用

### 4.1 認証フロー

```
┌─────────┐      ┌─────────────┐      ┌──────────────┐      ┌─────────┐
│ クライアント │ ──→ │ API Gateway │ ──→ │ 認証・認可レイヤー │ ──→ │ Cognito │
└─────────┘      └─────────────┘      └──────────────┘      └─────────┘
     ↑                                        │
     └────────────────────────────────────────┘
```

1. クライアントがログイン情報を送信
2. API Gatewayがリクエストを認証レイヤーに転送
3. 認証レイヤーがCognitoで認証を実行
4. 認証成功時、JWTトークンを生成しクライアントに返却

### 4.2 ビデオ通話セッション確立

```
┌─────────┐      ┌─────────────┐      ┌──────────────┐      ┌───────────────┐
│ クライアント │ ──→ │ API Gateway │ ──→ │ OHRモジュール   │ ──→ │ Amazon Chime │
└─────────┘      └─────────────┘      └──────────────┘      └───────────────┘
     ↑                                        │                      │
     └────────────────────────────────────────┴──────────────────────┘
```

1. クライアントが会議作成をリクエスト
2. OHRモジュールがAmazon Chime SDKで会議を作成
3. 参加トークンと会議情報をクライアントに返却
4. クライアントが直接Amazon Chimeと接続してビデオセッションを確立

### 4.3 メンタルヘルスチェック実行

```
┌─────────┐      ┌─────────────┐      ┌──────────────┐      ┌─────────┐
│ クライアント │ ──→ │ API Gateway │ ──→ │ HALCAモジュール │ ──→ │ AI/ML API │
└─────────┘      └─────────────┘      └──────────────┘      └─────────┘
     ↑                                        │                  │
     │                                        ▼                  │
     │                               ┌──────────────┐            │
     └───────────────────────────────│ PostgreSQL DB │←───────────┘
                                     └──────────────┘
```

1. クライアントが評価セッション開始をリクエスト
2. HALCAモジュールがセッションを作成し質問を取得
3. 必要に応じてAI/ML APIを使用して質問や応答を処理
4. 結果をデータベースに保存し、クライアントに返却

### 4.4 リアルタイムチャット

```
┌─────────┐      ┌─────────────┐      ┌──────────────┐
│ クライアント │ ──→ │ API Gateway │ ──→ │ チャットモジュール │
└─────────┘      └─────────────┘      └──────────────┘
     ↑                                        │
     │                                        ▼
     │                               ┌──────────────┐
     └─────────────────────────────→ │ WebSocketサーバー │
                                     └──────────────┘
```

1. クライアントがWebSocketサーバーに接続
2. メッセージ送信時、WebSocketを通じてチャットモジュールに転送
3. チャットモジュールがメッセージを処理し、受信者に転送
4. 永続化が必要なメッセージはデータベースに保存

## 5. デプロイメント構成

### 5.1 コンテナ構成

```
┌─────────────────────────────────────────────────────────────┐
│                   Docker Compose環境                        │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  app-web    │  │  app-api    │  │  app-worker │          │
│  │  コンテナ     │  │  コンテナ     │  │  コンテナ     │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  postgres   │  │    redis    │  │   minio     │          │
│  │  コンテナ     │  │  コンテナ     │  │  コンテナ     │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 AWS環境構成

```
┌─────────────────────────────────────────────────────────────┐
│                       AWS環境                               │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  ECS Service │  │  RDS Postgres│  │ ElastiCache │          │
│  │  (Fargate)   │  │  (Multi-AZ)  │  │   (Redis)   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  S3 Bucket  │  │   Cognito   │  │ CloudWatch  │          │
│  │             │  │  User Pool   │  │             │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 6. スケーラビリティと拡張性

### 6.1 水平スケーリング

- **API/Webサーバー**: ECS Fargateのタスク数増加
- **データベース**: RDSリードレプリカの追加
- **キャッシュ**: ElastiCacheクラスターのノード追加

### 6.2 モジュール拡張

新しい機能モジュールは以下のパターンに従って追加可能：

1. モジュールディレクトリ構造の作成
2. 共有カーネルとのインターフェース定義
3. APIエンドポイントの追加
4. データモデルの拡張
5. UIコンポーネントの追加

### 6.3 マイクロサービスへの移行パス

将来的なスケーリング要件に応じて、以下の手順でマイクロサービスへ移行可能：

1. モジュールごとにコンテナを分離
2. APIゲートウェイを介したルーティングの実装
3. サービス間通信の確立（REST, gRPC等）
4. データベースの分離（必要に応じて）
5. CI/CDパイプラインの更新

## 7. 障害対策と回復性

### 7.1 単一障害点の排除

- **データベース**: マルチAZデプロイメント
- **アプリケーション**: 複数コンテナでの冗長化
- **ストレージ**: S3の高耐久性活用

### 7.2 障害検出と自動復旧

- **ヘルスチェック**: 各コンポーネントの定期的な状態確認
- **自動再起動**: 障害検出時のコンテナ自動再起動
- **フェイルオーバー**: RDSスタンバイへの自動切り替え

### 7.3 バックアップと復元

- **データベース**: 日次自動バックアップ
- **設定**: 環境設定のバージョン管理
- **ユーザーデータ**: 定期的なエクスポートと保護

## 8. セキュリティ考慮事項

### 8.1 コンポーネント間通信

- **内部通信**: VPC内での暗号化通信
- **外部通信**: TLS 1.3による暗号化
- **API認証**: JWTトークンによる認証

### 8.2 データ保護

- **保存データ**: 暗号化（AES-256-GCM）
- **転送データ**: TLS/SSL暗号化
- **センシティブデータ**: 特別なアクセス制御と監査

### 8.3 アクセス制御

- **ユーザー権限**: RBACモデルによる詳細な権限管理
- **API制限**: レート制限とリソースベースの制限
- **管理アクセス**: 多要素認証と最小権限の原則

## 9. 監視と運用

### 9.1 監視指標

- **アプリケーション**: レスポンス時間、エラー率、リクエスト数
- **データベース**: クエリパフォーマンス、接続数、ディスク使用量
- **インフラストラクチャ**: CPU使用率、メモリ使用率、ネットワークトラフィック

### 9.2 ログ管理

- **アプリケーションログ**: 構造化ログ形式
- **アクセスログ**: APIリクエストとレスポンス
- **監査ログ**: セキュリティ関連イベント

### 9.3 アラート設定

- **重大度レベル**: 情報、警告、エラー、重大
- **通知チャネル**: メール、Slack、SMS
- **エスカレーションポリシー**: 対応時間に基づく段階的エスカレーション

## 10. 将来の拡張計画

### 10.1 予定されている拡張

- **モバイルアプリ**: ネイティブモバイルアプリケーション
- **分析モジュール**: 高度なデータ分析と可視化
- **AIアシスタント**: 診断支援と治療推奨

### 10.2 技術的負債の管理

- **コード品質**: 定期的なリファクタリング
- **依存関係**: 定期的な更新とセキュリティパッチ
- **ドキュメント**: 技術文書の継続的な更新

---

*このコンポーネント図文書は、HugMeDoプロジェクトの主要コンポーネントとその関連性を定義するものです。実装の詳細は変更される可能性があります。*

最終更新: 2025-03-21
