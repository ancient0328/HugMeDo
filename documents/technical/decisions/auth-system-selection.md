# 認証システム選定に関する意思決定記録

## 文書情報

| 項目 | 内容 |
|------|------|
| 文書番号 | DEC-001 |
| 作成日 | 2025-03-21 |
| 作成者 | HugMeDoチーム |
| ステータス | 承認済み |
| 関連文書 | ARCH-001（アーキテクチャ概要） |

## 1. 課題

HugMeDoプロジェクトにおいて、セキュアで拡張性のある認証システムを選定する必要がある。医療情報を扱うシステムとして、高いセキュリティ基準を満たしつつ、開発期間内（1週間）に実装可能な認証システムを決定する。

## 2. 検討オプション

以下の4つの認証システムオプションを検討した：

1. **Amazon Cognito**
   - マネージドサービスとしての認証システム
   - AWSネイティブ統合

2. **Keycloak**
   - オープンソースの認証・認可プラットフォーム
   - コンテナとして実行可能

3. **自前認証サービス**
   - Node.js/Expressで実装する独自認証システム
   - JWT + bcryptによる実装

4. **Supabase Auth**
   - オープンソースの認証システム
   - PostgreSQLと緊密に統合

## 3. 比較評価

### 3.1 評価基準

以下の基準で各オプションを評価：

1. **コスト効率**（初期コストと運用コスト）
2. **技術的難易度**（学習曲線、ドキュメント、サポート）
3. **実装速度**（1週間の制約内での実現可能性）
4. **堅牢性/セキュリティ**（医療情報システムとしての要件充足）
5. **カスタマイズ性**（要件に合わせた調整の容易さ）
6. **拡張性**（将来的な機能追加の容易さ）

### 3.2 詳細評価

#### 3.2.1 コスト効率

| オプション | 初期コスト | 運用コスト（月額） | 評価 |
|-----------|-----------|-----------------|------|
| Amazon Cognito | ゼロ（従量課金） | MAU 50,000人まで約2,000〜5,000円 | ★★★★☆ |
| Keycloak | ゼロ（オープンソース） | 専用EC2: 約5,000〜10,000円 | ★★★☆☆ |
| 自前認証サービス | 開発工数: 2〜3人日 | 追加インフラ不要 | ★★★★★ |
| Supabase Auth | 開発工数: 1〜2人日 | 最小限のインフラコスト | ★★★★☆ |

#### 3.2.2 技術的難易度

| オプション | 学習曲線 | ドキュメント | サポート | 評価 |
|-----------|---------|------------|---------|------|
| Amazon Cognito | 緩やか | 充実 | AWSサポート（有料） | ★★★★☆ |
| Keycloak | 急（複雑） | 充実だが複雑 | コミュニティ/有料 | ★★☆☆☆ |
| 自前認証サービス | 中程度 | 自己作成 | 自己対応 | ★★★☆☆ |
| Supabase Auth | 緩やか | 良好 | コミュニティ | ★★★★☆ |

#### 3.2.3 実装速度

| オプション | 実装時間 | テスト時間 | 統合時間 | 評価 |
|-----------|---------|----------|---------|------|
| Amazon Cognito | 約1日 | 約1日 | 約1日 | ★★★★☆ |
| Keycloak | 約2日 | 約1日 | 約1日 | ★★☆☆☆ |
| 自前認証サービス | 約1日 | 約1日 | 最小 | ★★★★★ |
| Supabase Auth | 約1日 | 約1日 | 約半日 | ★★★★☆ |

#### 3.2.4 堅牢性/セキュリティ

| オプション | セキュリティ標準 | 機能 | コンプライアンス | 評価 |
|-----------|----------------|------|---------------|------|
| Amazon Cognito | 高（AWS責任共有） | MFA、適応認証 | HIPAA, SOC, ISO等 | ★★★★★ |
| Keycloak | 高（エンタープライズ級） | MFA、SSO、詳細権限 | 設定次第 | ★★★★★ |
| 自前認証サービス | 実装次第（低〜中） | 基本認証のみ | 自己実装が必要 | ★★☆☆☆ |
| Supabase Auth | 中〜高 | JWTベース、ソーシャル | 自己実装が必要 | ★★★☆☆ |

#### 3.2.5 医療情報システムとしての適合性

| オプション | HIPAA対応 | データ暗号化 | アクセス制御 | 監査ログ | 評価 |
|-----------|----------|------------|------------|---------|------|
| Amazon Cognito | ✓ | ✓ | ✓ | ✓ | ★★★★★ |
| Keycloak | ✓（設定必要） | ✓（設定必要） | ✓ | ✓ | ★★★★☆ |
| 自前認証サービス | × | △（自己実装） | △（自己実装） | △（自己実装） | ★☆☆☆☆ |
| Supabase Auth | △（追加設定必要） | △（一部対応） | △（基本機能） | △（基本機能） | ★★☆☆☆ |

## 4. 決定と根拠

### 4.1 選定結果

**Amazon Cognito**を認証システムとして採用する。

### 4.2 選定理由

1. **バランスの取れた評価**:
   - 実装速度とセキュリティのバランスが最も良い
   - 1週間という短期間での実装が現実的

2. **医療情報システムとしての要件充足**:
   - HIPAA等のコンプライアンス対応が標準で含まれる
   - 堅牢なセキュリティ機能（MFA、適応認証等）

3. **コスト効率**:
   - 初期段階では従量課金で低コスト
   - ユーザー数増加に応じた段階的なコスト増加

4. **AWS環境との統合**:
   - 他のAWSサービス（ECS、RDS等）との緊密な統合
   - IAMポリシーによる一貫したアクセス制御

5. **運用負荷の軽減**:
   - マネージドサービスによる運用負荷の最小化
   - セキュリティアップデートの自動適用

## 5. 実装計画

### 5.1 短期実装計画（1週間）

| 日程 | 実装内容 |
|------|---------|
| Day 1 | Cognito設定（ユーザープール、アプリクライアント） |
| Day 2 | アプリケーションのCognito統合コード実装 |
| Day 3 | テストとデバッグ |
| Day 4-7 | 他のAWSサービス設定と統合テスト |

### 5.2 実装詳細

```javascript
// Cognito認証クライアント実装例
import { CognitoIdentityProviderClient, InitiateAuthCommand } from "@aws-sdk/client-cognito-identity-provider";

const client = new CognitoIdentityProviderClient({ region: "ap-northeast-1" });

export async function authenticateUser(username, password) {
  const params = {
    AuthFlow: "USER_PASSWORD_AUTH",
    ClientId: process.env.COGNITO_CLIENT_ID,
    AuthParameters: {
      USERNAME: username,
      PASSWORD: password,
    },
  };

  try {
    const command = new InitiateAuthCommand(params);
    const response = await client.send(command);
    return {
      token: response.AuthenticationResult.IdToken,
      refreshToken: response.AuthenticationResult.RefreshToken,
    };
  } catch (error) {
    console.error("Authentication error:", error);
    throw error;
  }
}
```

## 6. リスクと軽減策

### 6.1 識別されたリスク

1. **ベンダーロックイン**:
   - リスク: AWSサービスへの依存度が高まる
   - 軽減策: 認証ロジックを抽象化し、将来的な切り替えを容易にする

2. **コスト増加**:
   - リスク: ユーザー数増加に伴うコスト上昇
   - 軽減策: 使用量モニタリングとコスト最適化の定期的な見直し

3. **カスタマイズの制限**:
   - リスク: 特殊な認証フローの実装が制限される可能性
   - 軽減策: 事前に詳細な要件を確認し、Cognitoの制限を理解する

### 6.2 代替案

将来的な要件変更や制約に対応するため、以下の代替案を検討しておく：

1. **Keycloak移行計画**:
   - より高度なカスタマイズが必要になった場合
   - 実装の複雑さと引き換えに完全なコントロールを獲得

2. **Firebase Authentication**:
   - AWSエコシステム外での代替オプション
   - モバイルアプリ重視の場合に検討

## 7. 結論

Amazon Cognitoは、HugMeDoプロジェクトの現在の制約（1週間での実装）と要件（医療情報システムとしてのセキュリティ）を最もバランス良く満たす選択肢である。将来的な拡張性も考慮し、適切な抽象化を行うことで、必要に応じて他の認証システムへの移行パスも確保する。

---

*このドキュメントは、HugMeDoプロジェクトの認証システム選定に関する意思決定を記録するものです。プロジェクトの進行に伴い、必要に応じて見直しと更新を行います。*

最終更新: 2025-03-21
