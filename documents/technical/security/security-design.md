# HugMeDo セキュリティ設計書

## 文書情報

| 項目 | 内容 |
|------|------|
| 文書番号 | ARCH-004 |
| 作成日 | 2025-03-21 |
| 作成者 | HugMeDoチーム |
| ステータス | ドラフト |
| 関連文書 | ARCH-001（アーキテクチャ概要）, ARCH-002（データベース設計）, ARCH-003（コンポーネント図） |

## 1. 概要

本文書は、HugMeDoプラットフォームのセキュリティ設計を定義します。医療情報システムとして求められる高度なセキュリティ要件を満たすための設計方針、実装方法、運用手順を説明します。

## 2. セキュリティ設計の基本方針

### 2.1 セキュリティの基本原則

HugMeDoプラットフォームは以下の基本原則に基づいてセキュリティを設計しています：

1. **多層防御（Defense in Depth）**: 複数の防御層を設けることで、単一の防御策が破られても全体のセキュリティを維持
2. **最小権限の原則**: 各ユーザー、プロセス、コンポーネントに必要最小限の権限のみを付与
3. **セキュアバイデザイン**: 設計段階からセキュリティを考慮し、後付けではなく組み込みとして実装
4. **プライバシーバイデザイン**: 個人情報保護を設計の中核に据え、必要最小限のデータ収集と適切な保護を実施
5. **継続的なセキュリティ評価**: 定期的な脆弱性評価とセキュリティテストの実施

### 2.2 コンプライアンス要件

HugMeDoプラットフォームは以下の法規制とガイドラインに準拠します：

1. **個人情報保護法**: 個人情報の適切な取り扱いと保護
2. **医療情報システムの安全管理に関するガイドライン**: 厚生労働省が定める医療情報システムのセキュリティ基準
3. **HIPAA（将来の国際展開に備えて）**: 米国の医療情報保護法
4. **GDPR（将来の国際展開に備えて）**: EU一般データ保護規則

## 3. 認証と認可

### 3.1 認証システム

#### 3.1.1 Amazon Cognitoの採用

HugMeDoプラットフォームでは、Amazon Cognitoをユーザー認証システムとして採用しています：

- **ユーザープール**: ユーザー登録、認証、アカウント管理
- **IDプール**: 一時的なAWS認証情報の提供（必要に応じて）
- **フェデレーテッド認証**: ソーシャルIDプロバイダーとの連携（オプション）

#### 3.1.2 認証フロー

```
┌─────────┐      ┌─────────────┐      ┌──────────────┐      ┌─────────┐
│ クライアント │ ──→ │ API Gateway │ ──→ │ 認証サービス   │ ──→ │ Cognito │
└─────────┘      └─────────────┘      └──────────────┘      └─────────┘
     ↑                                        │
     └────────────────────────────────────────┘
         JWT Token
```

1. ユーザーがログイン情報（メールアドレス/パスワード）を送信
2. 認証サービスがCognitoでユーザーを認証
3. 認証成功時、JWTトークンを生成
4. トークンをクライアントに返却し、以降のリクエストに使用

#### 3.1.3 多要素認証（MFA）

- **SMS/Eメール認証**: 二段階認証としてワンタイムパスワードを送信
- **TOTP**: Google AuthenticatorやAuthy等のアプリを使用したタイムベースワンタイムパスワード
- **適用ポリシー**: 管理者アカウントには必須、一般ユーザーにはオプション

### 3.2 認可システム

#### 3.2.1 ロールベースアクセス制御（RBAC）

以下の基本ロールを定義し、細かい権限を設定します：

- **患者（Patient）**: 自身の医療情報へのアクセス、予約管理、メッセージング
- **医師（Doctor）**: 担当患者の医療情報へのアクセス、診察スケジュール管理
- **管理者（Admin）**: システム設定、ユーザー管理、監査ログ確認
- **システム（System）**: バックグラウンドプロセス、自動化タスク

#### 3.2.2 属性ベースアクセス制御（ABAC）

RBACを補完するために、以下の属性に基づいたきめ細かいアクセス制御を実装：

- **関係性**: 医師-患者の関係性に基づくアクセス制御
- **データ所有権**: データ所有者のみがアクセス可能
- **時間制約**: 特定の時間帯のみアクセス可能（予約時間内など）
- **地理的制約**: 特定の地域からのアクセスのみ許可（オプション）

#### 3.2.3 APIアクセス制御

- **JWT検証**: 各APIリクエストでJWTトークンを検証
- **スコープチェック**: トークンに含まれるスコープに基づいてアクセス制御
- **レート制限**: ユーザーごとのAPIリクエスト数の制限
- **IPフィルタリング**: 管理機能への特定IPからのアクセス制限（オプション）

## 認証・認可の実装

### 認証システム

HugMeDoでは、Amazon Cognitoを使用してユーザー認証を実装します。認証関連のインターフェースは`packages/core/src/auth`で定義され、実際の実装は`modules/api-gateway`で行われます。

#### 認証フロー

1. ユーザーがログインフォームに認証情報を入力
2. フロントエンドアプリケーションが`packages/core/src/auth`の認証インターフェースを通じてAPIゲートウェイに認証リクエストを送信
3. APIゲートウェイがAmazon Cognitoと連携して認証を実行
4. 認証成功時、JWTトークンが発行され、クライアントに返却
5. クライアントはトークンをローカルストレージに保存し、以降のAPIリクエストに含める

#### 認証コンポーネント

- **AuthInterface**: `packages/core/src/auth`で定義される認証インターフェース
- **AuthProvider**: 認証状態を管理するSvelteストア
- **ProtectedRoute**: 認証が必要なルートを保護するコンポーネント
- **useAuth**: 認証機能にアクセスするためのカスタムフック

## 4. データ保護

### 4.1 保存データの暗号化

#### 4.1.1 データベース暗号化

- **RDS暗号化**: AWS KMSを使用したRDSインスタンスの暗号化
- **バックアップ暗号化**: データベースバックアップの自動暗号化
- **スナップショット暗号化**: データベーススナップショットの暗号化

#### 4.1.2 フィールドレベル暗号化

以下の機密データは、データベースレベルとは別に、アプリケーションレベルで暗号化：

- **医療情報**: 診断結果、処方情報、検査結果
- **個人識別情報**: 氏名、生年月日、住所、電話番号
- **認証情報**: パスワードハッシュ、セキュリティ質問の回答

使用する暗号化アルゴリズム：
- **対称暗号**: AES-256-GCM
- **鍵管理**: AWS KMS

#### 4.1.3 ファイル暗号化

- **S3暗号化**: サーバーサイド暗号化（SSE-KMS）
- **クライアント暗号化**: 特に機密性の高いファイルには、アップロード前のクライアント側暗号化を実施

### 4.2 転送中データの暗号化

#### 4.2.1 TLS/SSL暗号化

- **TLS 1.3**: 全ての通信にTLS 1.3を使用
- **証明書管理**: AWS Certificate Managerを使用した証明書管理
- **HSTS**: HTTP Strict Transport Securityの実装

#### 4.2.2 APIセキュリティ

- **署名付きリクエスト**: 重要なAPIリクエストには署名を要求
- **一時的認証情報**: 長期的な認証情報の代わりに一時的な認証情報を使用
- **セキュアヘッダー**: Content-Security-Policy, X-XSS-Protection等のセキュリティヘッダーの設定

### 4.3 キー管理

#### 4.3.1 AWS KMSの活用

- **CMK（カスタマーマスターキー）**: サービス専用のCMKを作成
- **キーローテーション**: 自動キーローテーションの有効化（年次）
- **アクセス制御**: KMSキーへのアクセスを最小限に制限

#### 4.3.2 シークレット管理

- **AWS Secrets Manager**: データベース認証情報、APIキー等の管理
- **環境変数**: 非機密設定は環境変数として管理
- **自動ローテーション**: 重要な認証情報の定期的な自動ローテーション

## 5. インフラストラクチャセキュリティ

### 5.1 ネットワークセキュリティ

#### 5.1.1 VPC設計

```
┌─────────────────────────────────────────────────────────────┐
│                           VPC                               │
│                                                             │
│  ┌─────────────────┐      ┌─────────────────┐               │
│  │  パブリックサブネット │      │  パブリックサブネット │               │
│  │    (AZ-1)      │      │    (AZ-2)      │               │
│  │                │      │                │               │
│  │  ┌───────────┐ │      │  ┌───────────┐ │               │
│  │  │   NAT    │ │      │  │   NAT    │ │               │
│  │  │ ゲートウェイ │ │      │  │ ゲートウェイ │ │               │
│  │  └───────────┘ │      │  └───────────┘ │               │
│  └────────┬────────┘      └────────┬────────┘               │
│           │                        │                        │
│  ┌────────▼────────┐      ┌────────▼────────┐               │
│  │ プライベートサブネット │      │ プライベートサブネット │               │
│  │    (AZ-1)      │      │    (AZ-2)      │               │
│  │                │      │                │               │
│  │  ┌───────────┐ │      │  ┌───────────┐ │               │
│  │  │  アプリケーション │ │      │  │  アプリケーション │ │               │
│  │  │  サーバー   │ │      │  │  サーバー   │ │               │
│  │  └───────────┘ │      │  └───────────┘ │               │
│  └────────┬────────┘      └────────┬────────┘               │
│           │                        │                        │
│  ┌────────▼────────┐      ┌────────▼────────┐               │
│  │ データベースサブネット │      │ データベースサブネット │               │
│  │    (AZ-1)      │      │    (AZ-2)      │               │
│  │                │      │                │               │
│  │  ┌───────────┐ │      │  ┌───────────┐ │               │
│  │  │ データベース │ │      │  │ データベース │ │               │
│  │  │ (プライマリ) │ │      │  │ (スタンバイ) │ │               │
│  │  └───────────┘ │      │  └───────────┘ │               │
│  └─────────────────┘      └─────────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

- **マルチAZ配置**: 可用性向上のため、複数のアベイラビリティゾーンにリソースを配置
- **サブネット分離**: パブリック、プライベート、データベースサブネットの明確な分離
- **NAT Gateway**: プライベートサブネットからのアウトバウンド通信用

#### 5.1.2 セキュリティグループとNACL

- **セキュリティグループ**: インスタンスレベルのファイアウォール
  - Webサーバー: 80/443ポートのみ許可
  - アプリケーションサーバー: 特定ポートのみ許可
  - データベース: アプリケーションサーバーからの接続のみ許可

- **NACL（ネットワークACL）**: サブネットレベルのファイアウォール
  - 不要なプロトコルとポートのブロック
  - 既知の悪意あるIPアドレスのブロック

#### 5.1.3 WAF（Web Application Firewall）

- **AWS WAF**: SQLインジェクション、XSS等の一般的な攻撃からの保護
- **カスタムルール**: アプリケーション固有の脆弱性に対するカスタムルールの作成
- **レート制限**: DDoS攻撃対策としてのレート制限

### 5.2 コンテナセキュリティ

#### 5.2.1 イメージセキュリティ

- **最小ベースイメージ**: 攻撃対象領域を減らすための最小限のベースイメージ使用
- **イメージスキャン**: 脆弱性スキャンの自動実行
- **イメージ署名**: イメージの整合性を確保するための署名検証

#### 5.2.2 コンテナランタイムセキュリティ

- **権限最小化**: 非rootユーザーでのコンテナ実行
- **読み取り専用ファイルシステム**: 可能な限り読み取り専用ファイルシステムを使用
- **リソース制限**: CPUとメモリの使用制限の設定

#### 5.2.3 シークレット管理

- **環境変数注入**: 機密情報を環境変数として安全に注入
- **一時的ストレージ**: 機密情報の一時的なメモリ内保存
- **外部シークレットストア**: AWS Secrets Managerとの連携

### 5.3 サーバーセキュリティ

#### 5.3.1 サーバーハードニング

- **最小インストール**: 必要最小限のパッケージのみをインストール
- **自動パッチ適用**: セキュリティパッチの自動適用
- **不要サービスの無効化**: 不要なサービスとポートの無効化

#### 5.3.2 ホストベースセキュリティ

- **ウイルス対策**: リアルタイムスキャンと定期スキャン
- **ファイル整合性監視**: 重要システムファイルの変更検知
- **侵入検知/防止**: 異常な活動の検知と防止

## 6. アプリケーションセキュリティ

### 6.1 セキュアコーディング

#### 6.1.1 コーディング標準

- **OWASP Top 10対策**: OWASP Top 10の脆弱性に対する対策実装
- **コードレビュー**: セキュリティフォーカスのコードレビュー実施
- **静的解析**: 自動化された静的コード解析の実施

#### 6.1.2 入力検証

- **サーバーサイド検証**: すべての入力データのサーバーサイド検証
- **パラメータ化クエリ**: SQLインジェクション対策
- **出力エンコーディング**: XSS対策としての出力エンコーディング

#### 6.1.3 セッション管理

- **セキュアなセッションID**: 予測不可能なセッションID生成
- **セッションタイムアウト**: 適切なセッションタイムアウト設定
- **セッション無効化**: ログアウト時のセッション完全無効化

### 6.2 APIセキュリティ

#### 6.2.1 APIゲートウェイ

- **認証と認可**: すべてのAPIエンドポイントでの認証と認可
- **入力検証**: リクエストデータの検証
- **レート制限**: APIリクエスト数の制限

#### 6.2.2 クロスオリジンリソース共有（CORS）

- **制限的CORS設定**: 必要最小限のオリジンのみ許可
- **プリフライトリクエスト**: 複雑なリクエストのプリフライト検証
- **認証情報**: 適切な認証情報ポリシーの設定

### 6.3 フロントエンドセキュリティ

#### 6.3.1 CSP（Content Security Policy）

```
Content-Security-Policy: default-src 'self';
                         script-src 'self' https://trusted-cdn.com;
                         style-src 'self' https://trusted-cdn.com;
                         img-src 'self' data: https://trusted-cdn.com;
                         connect-src 'self' https://api.hugmedo.com;
                         frame-ancestors 'none';
                         form-action 'self';
```

- **スクリプト制限**: 信頼できるソースからのスクリプトのみ実行
- **インラインスクリプト禁止**: インラインスクリプトの禁止
- **フレーム制限**: クリックジャッキング対策

#### 6.3.2 その他のセキュリティヘッダー

- **X-XSS-Protection**: ブラウザのXSS保護機能の有効化
- **X-Content-Type-Options**: MIMEタイプスニッフィングの防止
- **Referrer-Policy**: リファラー情報の制限

## 7. 監査とログ記録

### 7.1 監査ログ

#### 7.1.1 ログ記録対象

以下のイベントを監査ログとして記録：

- **認証イベント**: ログイン成功/失敗、ログアウト、パスワード変更
- **アクセス制御**: 権限変更、アクセス拒否
- **データアクセス**: 機密データの閲覧、変更、削除
- **システム変更**: 設定変更、システム更新
- **セキュリティイベント**: 異常検知、ポリシー違反

#### 7.1.2 ログ内容

各ログエントリには以下の情報を含める：

- **タイムスタンプ**: イベント発生日時（UTC）
- **イベントタイプ**: 実行されたアクション
- **ユーザー識別子**: アクションを実行したユーザー
- **IPアドレス**: アクセス元IPアドレス
- **リソース識別子**: アクセスされたリソース
- **結果**: 成功/失敗とエラーコード（該当する場合）
- **詳細情報**: イベント固有の追加情報

#### 7.1.3 ログ保存

- **保存期間**: 最低5年間（医療情報システムガイドラインに準拠）
- **保存場所**: CloudWatch Logs → S3（長期保存）
- **暗号化**: 保存ログの暗号化
- **アクセス制御**: ログへのアクセス制限と監査

### 7.2 セキュリティ監視

#### 7.2.1 リアルタイム監視

- **CloudWatch Alarms**: 重要指標の閾値アラート
- **GuardDuty**: 異常な活動の検知
- **セキュリティダッシュボード**: セキュリティ状態の可視化

#### 7.2.2 インシデント対応

- **アラート通知**: メール、SMS、Slackへの通知
- **自動応答**: 特定の脅威に対する自動対応
- **エスカレーションプロセス**: 重大度に応じたエスカレーション

## 8. 脆弱性管理

### 8.1 脆弱性スキャン

#### 8.1.1 定期スキャン

- **インフラストラクチャスキャン**: ネットワークとサーバーの脆弱性スキャン（月次）
- **アプリケーションスキャン**: Webアプリケーションの脆弱性スキャン（月次）
- **コンテナスキャン**: コンテナイメージの脆弱性スキャン（ビルド時と週次）

#### 8.1.2 継続的スキャン

- **依存関係チェック**: サードパーティライブラリの脆弱性チェック（CI/CDパイプライン内）
- **コード解析**: 静的コード解析（コミット時とビルド時）
- **動的解析**: 動的アプリケーションセキュリティテスト（デプロイ前）

### 8.2 ペネトレーションテスト

- **範囲**: インフラストラクチャ、アプリケーション、API
- **頻度**: 年次および重大な変更後
- **方法**: 外部セキュリティ専門家による実施

### 8.3 脆弱性対応

- **重大度評価**: CVSS（Common Vulnerability Scoring System）に基づく評価
- **修正タイムライン**: 重大度に応じた修正期限の設定
  - 重大（Critical）: 24時間以内
  - 高（High）: 1週間以内
  - 中（Medium）: 1ヶ月以内
  - 低（Low）: 3ヶ月以内
- **検証**: 修正後の再テストによる検証

## 9. 災害復旧とビジネス継続性

### 9.1 バックアップ戦略

- **データベースバックアップ**: 日次自動バックアップ、ポイントインタイムリカバリ
- **設定バックアップ**: インフラストラクチャ設定の定期的なバックアップ
- **コードリポジトリ**: ソースコードの複数リポジトリへのミラーリング

### 9.2 災害復旧計画

- **RTO（Recovery Time Objective）**: 4時間以内
- **RPO（Recovery Point Objective）**: 15分以内
- **フェイルオーバー**: 自動フェイルオーバーメカニズム
- **リージョン間レプリケーション**: クリティカルデータの複数リージョンへのレプリケーション（オプション）

### 9.3 定期的なテスト

- **復旧テスト**: バックアップからの復旧テスト（四半期ごと）
- **フェイルオーバーテスト**: フェイルオーバーメカニズムのテスト（半年ごと）
- **完全DR演習**: 完全な災害復旧演習（年次）

## 10. セキュリティ運用

### 10.1 セキュリティチーム

- **責任者**: 情報セキュリティ責任者（CISO）の指名
- **体制**: セキュリティ専門家とシステム管理者で構成
- **外部支援**: 必要に応じてセキュリティコンサルタントの活用

### 10.2 セキュリティポリシー

- **ポリシー文書**: 包括的なセキュリティポリシーの文書化
- **教育**: 全開発者と運用担当者へのセキュリティ教育
- **レビュー**: 定期的なポリシーレビューと更新（年次）

### 10.3 インシデント対応

- **対応計画**: 詳細なインシデント対応計画の策定
- **連絡体制**: 明確なエスカレーションパスと連絡先リスト
- **事後分析**: インシデント後の詳細な分析と改善

## 11. 第三者評価とコンプライアンス

### 11.1 セキュリティ評価

- **外部監査**: 第三者によるセキュリティ監査（年次）
- **コンプライアンス評価**: 医療情報システムガイドラインへの準拠評価
- **脆弱性開示プログラム**: 責任ある脆弱性開示プログラムの実施

### 11.2 認証取得

- **ISMS認証**: ISO 27001認証の取得（計画）
- **医療情報システム認証**: 医療情報システム向けセキュリティ認証の取得（計画）

## 12. 将来の拡張計画

### 12.1 セキュリティ強化計画

- **ゼロトラスト実装**: ゼロトラストアーキテクチャへの移行
- **高度な脅威検知**: AIベースの脅威検知システムの導入
- **量子耐性暗号**: 将来的な量子コンピュータの脅威に対応した暗号化

### 12.2 国際展開に向けた準拠計画

- **HIPAA準拠**: 米国市場展開に向けたHIPAA要件への対応
- **GDPR完全準拠**: EU市場展開に向けたGDPR要件への完全対応
- **地域別コンプライアンス**: 各地域の規制に対応するための柔軟なフレームワーク

---

*このセキュリティ設計書は、HugMeDoプロジェクトのセキュリティ要件と実装方法を定義するものです。実装の詳細は変更される可能性があります。*

最終更新: 2025-03-21
